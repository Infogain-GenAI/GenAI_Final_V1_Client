trigger:
- none

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js'

- script: |
    npm install
  displayName: 'Install Node.js dependencies'

- script: |
    npm start &
    sleep 30
  displayName: 'Start Node.js server'

- bash: | 
   echo $(targetURL)
   chmod -R 777  ./
   docker run --rm -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t $(targetURL) -J report.json -r report.html 
   true
  displayName: 'Owasp Container Scan'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(System.DefaultWorkingDirectory)/report.html'
    artifact: 'ZAP Report'
  displayName: 'Publish ZAP Report'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'devops_tools' 
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: | 
      curl --max-time 60 "https://html5.validator.nu/?doc=$(targetURL)" > html_validation_report.txt
  displayName: 'Call HTML Validation API'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: html_validation_report.txt
    ArtifactName: 'API_Response'
    publishLocation: 'Container'    